name: Build Android AAB

on:
  workflow_dispatch:
    inputs:
      app_variant:
        description: 'Which app to build'
        required: true
        default: 'rider'
        type: choice
        options:
          - rider
          - driver
          - both
      publish_track:
        description: 'Publish to Google Play track'
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - internal
          - alpha
          - beta
          - production

jobs:
  build-rider:
    if: ${{ github.event.inputs.app_variant == 'rider' || github.event.inputs.app_variant == 'both' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Setup Expo CLI
        run: npm install -g expo-cli @expo/ngrok

      - name: Copy rider app config
        run: cp app.rider.json app.json

      - name: Generate Android project
        run: npx expo prebuild --platform android --clean

      - name: Fix Google Maps API key in manifest
        run: |
          sed -i 's/\${GOOGLE_API_KEY}/${{ secrets.GOOGLE_API_KEY }}/g' android/app/src/main/AndroidManifest.xml

      - name: Decode keystore
        run: |
          echo "${{ secrets.RIDER_KEYSTORE_BASE64 }}" | base64 -d > android/app/rider-keystore.jks

      - name: Create signing config
        run: |
          cat >> android/app/build.gradle << 'EOF'

          android {
              signingConfigs {
                  release {
                      storeFile file("rider-keystore.jks")
                      storePassword "${{ secrets.RIDER_KEYSTORE_PASSWORD }}"
                      keyAlias "${{ secrets.RIDER_KEY_ALIAS }}"
                      keyPassword "${{ secrets.RIDER_KEY_PASSWORD }}"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF

      - name: Build signed AAB with Gradle
        working-directory: android
        run: ./gradlew bundleRelease -Dorg.gradle.jvmargs="-Xmx4096m"

      - name: Build signed APK with Gradle
        working-directory: android
        run: ./gradlew assembleRelease -Dorg.gradle.jvmargs="-Xmx4096m"

      - name: Rename outputs
        run: |
          mv android/app/build/outputs/bundle/release/app-release.aab t-ride.aab
          mv android/app/build/outputs/apk/release/app-release.apk t-ride.apk

      - name: Upload T Ride AAB
        uses: actions/upload-artifact@v4
        with:
          name: t-ride-aab
          path: t-ride.aab
          retention-days: 30

      - name: Upload T Ride APK
        uses: actions/upload-artifact@v4
        with:
          name: t-ride-apk
          path: t-ride.apk
          retention-days: 30

      - name: Publish to Google Play
        if: ${{ github.event.inputs.publish_track != 'none' }}
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        run: |
          npm install googleapis
          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" | base64 -d > service-account.json
          export GOOGLE_PLAY_SERVICE_ACCOUNT_JSON=$(cat service-account.json)
          node scripts/publish-to-play-store.js rider t-ride.aab ${{ github.event.inputs.publish_track }}

  build-driver:
    if: ${{ github.event.inputs.app_variant == 'driver' || github.event.inputs.app_variant == 'both' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Setup Expo CLI
        run: npm install -g expo-cli @expo/ngrok

      - name: Copy driver app config
        run: cp app.driver.json app.json

      - name: Generate Android project
        run: npx expo prebuild --platform android --clean

      - name: Fix Google Maps API key in manifest
        run: |
          sed -i 's/\${GOOGLE_API_KEY}/${{ secrets.GOOGLE_API_KEY }}/g' android/app/src/main/AndroidManifest.xml

      - name: Decode keystore
        run: |
          echo "${{ secrets.DRIVER_KEYSTORE_BASE64 }}" | base64 -d > android/app/driver-keystore.jks

      - name: Create signing config
        run: |
          cat >> android/app/build.gradle << 'EOF'

          android {
              signingConfigs {
                  release {
                      storeFile file("driver-keystore.jks")
                      storePassword "${{ secrets.DRIVER_KEYSTORE_PASSWORD }}"
                      keyAlias "${{ secrets.DRIVER_KEY_ALIAS }}"
                      keyPassword "${{ secrets.DRIVER_KEY_PASSWORD }}"
                  }
              }
              buildTypes {
                  release {
                      signingConfig signingConfigs.release
                  }
              }
          }
          EOF

      - name: Build signed AAB with Gradle
        working-directory: android
        run: ./gradlew bundleRelease -Dorg.gradle.jvmargs="-Xmx4096m"

      - name: Build signed APK with Gradle
        working-directory: android
        run: ./gradlew assembleRelease -Dorg.gradle.jvmargs="-Xmx4096m"

      - name: Rename outputs
        run: |
          mv android/app/build/outputs/bundle/release/app-release.aab t-driver.aab
          mv android/app/build/outputs/apk/release/app-release.apk t-driver.apk

      - name: Upload T Driver AAB
        uses: actions/upload-artifact@v4
        with:
          name: t-driver-aab
          path: t-driver.aab
          retention-days: 30

      - name: Upload T Driver APK
        uses: actions/upload-artifact@v4
        with:
          name: t-driver-apk
          path: t-driver.apk
          retention-days: 30

      - name: Publish to Google Play
        if: ${{ github.event.inputs.publish_track != 'none' }}
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        run: |
          npm install googleapis
          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT_JSON" | base64 -d > service-account.json
          export GOOGLE_PLAY_SERVICE_ACCOUNT_JSON=$(cat service-account.json)
          node scripts/publish-to-play-store.js driver t-driver.aab ${{ github.event.inputs.publish_track }}
